<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Noticia - Niagara Viajes</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link th:href="@{/css/sidebar-fragment.css}" rel="stylesheet">
    <link th:href="@{/css/createNews.css}" rel="stylesheet">
   
</head>
<body>
    <!-- Contenedor principal -->
    <div class="main-container">
        <!-- Incluir Sidebar -->
        <div th:replace="fragments/sidebar-fragment :: sidebar(activeSection='noticias')"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Mensajes Flash -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show flash-message mb-4" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show flash-message mb-4" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="content-header">
                <div>
                    <h1 class="h3">
                        <i class="fas fa-plus-circle me-2"></i>
                        Crear Nueva Noticia
                    </h1>
                    <div class="text-muted">Complete la información de la noticia</div>
                </div>
                <div class="mt-2 mt-md-0">
                    <a th:href="@{/admin/noticias/newsList}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver a la Lista
                    </a>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Información de la Noticia
                    </h5>
                </div>
                <div class="card-body">
                    <!-- ¡IMPORTANTE: Añadir novalidate al formulario! -->
                    <form th:action="@{/admin/noticias/createNews}" 
                          th:object="${noticiaDTO}" 
                          method="post"
                          id="noticiaForm"
                          novalidate>
                        
                        <!-- Título -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Título de la Noticia <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control" 
                                   th:field="*{titulo}"
                                   placeholder="Ej: Nuevas Rutas de Vuelo a Europa"
                                   id="tituloInput"
                                   maxlength="150">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}">
                                <span th:errors="*{titulo}"></span>
                            </div>
                            <div class="form-text text-end">
                                <span id="tituloCounter">0</span>/150 caracteres
                            </div>
                        </div>

                        <!-- URL de la Imagen -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">URL de la Imagen</label>
                            <input type="url" 
                                   class="form-control" 
                                   th:field="*{imagenUrl}"
                                   placeholder="https://ejemplo.com/noticia.jpg"
                                   id="imagenUrl"
                                   maxlength="500">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('imagenUrl')}">
                                <span th:errors="*{imagenUrl}"></span>
                            </div>
                            <div class="form-text">Opcional. URL de la imagen principal. Dejar en blanco para usar imagen por defecto.</div>
                        </div>

                        <!-- Contenido -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Contenido de la Noticia <span class="text-danger">*</span></label>
                            <textarea class="form-control" 
                                      th:field="*{contenido}"
                                      rows="6" 
                                      placeholder="Escriba aquí el contenido completo de la noticia..."
                                      id="contenidoNoticia"></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('contenido')}">
                                <span th:errors="*{contenido}"></span>
                            </div>
                            <div class="form-text text-end">
                                <span id="contenidoCounter">0</span> caracteres
                            </div>
                        </div>

                        <!-- Enlace de Facebook -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fab fa-facebook me-1 text-primary"></i>
                                Enlace de Facebook
                            </label>
                            <input type="url" 
                                   class="form-control" 
                                   th:field="*{enlaceFacebook}"
                                   placeholder="https://www.facebook.com/tupagina/posts/123456789"
                                   id="facebookLink"
                                   maxlength="500">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('enlaceFacebook')}">
                                <span th:errors="*{enlaceFacebook}"></span>
                            </div>
                            <div class="form-text">Opcional. Enlace a la publicación en Facebook.</div>
                        </div>

                        <!-- Texto de Facebook -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fab fa-facebook me-1 text-primary"></i>
                                Texto de la Publicación en Facebook
                            </label>
                            <textarea class="form-control" 
                                      th:field="*{textoFacebook}"
                                      rows="3" 
                                      placeholder="Texto que apareció en la publicación de Facebook..."
                                      id="facebookText"
                                      maxlength="500"></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('textoFacebook')}">
                                <span th:errors="*{textoFacebook}"></span>
                            </div>
                            <div class="form-text text-end">
                                <span id="facebookTextCounter">0</span>/500 caracteres
                            </div>
                        </div>

                        <!-- Opciones -->
                        <div class="row mb-4">
                            <div class="col-lg-6 mb-3 mb-lg-0">
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           th:field="*{destacada}"
                                           id="destacadaSwitch">
                                    <label class="form-check-label fw-bold ms-2" for="destacadaSwitch">
                                        <i class="fas fa-star me-1 text-warning"></i>
                                        Marcar como Destacada
                                    </label>
                                </div>
                                <small class="d-block text-muted ms-5 ps-2 mt-1">
                                    Las noticias destacadas aparecen en lugares especiales del sitio.
                                </small>
                            </div>

                            <div class="col-lg-6">
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           th:field="*{activa}"
                                           checked
                                           id="activaSwitch">
                                    <label class="form-check-label fw-bold ms-2" for="activaSwitch">
                                        <i class="fas fa-eye me-1 text-success"></i>
                                        Publicar Inmediatamente
                                    </label>
                                </div>
                                <small class="d-block text-muted ms-5 ps-2 mt-1">
                                    Desmarque para guardar como borrador.
                                </small>
                            </div>
                        </div>

                        <!-- Vista Previa -->
                        <div class="card border-info mb-4">
                            <div class="card-header bg-info text-white">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-eye me-2"></i>
                                    Vista Previa
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="previewContent" class="preview-content">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-newspaper fa-3x mb-3"></i>
                                        <p>La vista previa se generará automáticamente<br>conforme complete los campos.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between pt-3 border-top">
                            <a th:href="@{/admin/noticias/newsList}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save me-2"></i>Crear Noticia
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script corregido para producción -->
    <script>
        (function() {
            'use strict';
            
            console.log('=== Niagara News Creator v1.0 ===');
            console.log('Entorno: Producción');
            console.log('URL:', window.location.href);
            
            // Verificar dependencias críticas
            function checkDependencies() {
                console.log('Verificando dependencias...');
                
                const requiredElements = [
                    'tituloInput',
                    'contenidoNoticia',
                    'noticiaForm',
                    'previewContent'
                ];
                
                const missing = [];
                requiredElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (!element) {
                        missing.push(id);
                        console.warn('Elemento no encontrado:', id);
                    }
                });
                
                if (missing.length > 0) {
                    console.error('Elementos faltantes:', missing);
                    return false;
                }
                
                console.log('Todas las dependencias encontradas');
                return true;
            }
            
            // Contadores de caracteres con manejo robusto
            function setupCharacterCounters() {
                try {
                    console.log('Configurando contadores de caracteres...');
                    
                    const countersConfig = [
                        { 
                            inputId: 'tituloInput', 
                            counterId: 'tituloCounter', 
                            max: 150 
                        },
                        { 
                            inputId: 'contenidoNoticia', 
                            counterId: 'contenidoCounter', 
                            max: null 
                        },
                        { 
                            inputId: 'facebookText', 
                            counterId: 'facebookTextCounter', 
                            max: 500 
                        }
                    ];
                    
                    countersConfig.forEach(config => {
                        const input = document.getElementById(config.inputId);
                        const counter = document.getElementById(config.counterId);
                        
                        if (input && counter) {
                            // Función para actualizar el contador
                            const updateCounter = () => {
                                try {
                                    const length = input.value.length;
                                    counter.textContent = config.max ? 
                                        `${length}/${config.max}` : 
                                        `${length}`;
                                } catch (e) {
                                    console.error(`Error actualizando contador ${config.counterId}:`, e);
                                }
                            };
                            
                            // Actualizar contador inicial
                            updateCounter();
                            
                            // Escuchar cambios con debounce para mejor performance
                            let timeout;
                            input.addEventListener('input', function() {
                                clearTimeout(timeout);
                                timeout = setTimeout(updateCounter, 50);
                            });
                            
                            // También actualizar en eventos de cambio
                            input.addEventListener('change', updateCounter);
                            
                            console.log(`Contador configurado: ${config.inputId}`);
                        } else {
                            console.warn(`No se pudo configurar contador: ${config.inputId}`);
                        }
                    });
                    
                    console.log('Contadores configurados correctamente');
                } catch (error) {
                    console.error('Error crítico en setupCharacterCounters:', error);
                }
            }
            
            // Vista previa en tiempo real con manejo de errores
            function setupLivePreview() {
                try {
                    console.log('Configurando vista previa...');
                    
                    const previewContent = document.getElementById('previewContent');
                    if (!previewContent) {
                        console.error('Elemento previewContent no encontrado');
                        return;
                    }
                    
                    // Función para escapar HTML (seguridad)
                    const escapeHtml = (text) => {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    };
                    
                    // Función para actualizar la vista previa
                    const updatePreview = () => {
                        try {
                            const tituloInput = document.getElementById('tituloInput');
                            const contenidoInput = document.getElementById('contenidoNoticia');
                            const imagenUrlInput = document.getElementById('imagenUrl');
                            
                            if (!tituloInput || !contenidoInput) {
                                console.warn('Campos requeridos no encontrados para vista previa');
                                return;
                            }
                            
                            const titulo = escapeHtml(tituloInput.value) || 'Título de la noticia';
                            const contenido = escapeHtml(contenidoInput.value) || 'Contenido de la noticia...';
                            const imagenUrl = imagenUrlInput ? 
                                escapeHtml(imagenUrlInput.value) : 
                                'https://via.placeholder.com/800x400/4a6fa5/ffffff?text=Niagara+Viajes';
                            
                            const previewHTML = `
                                <div class="preview-card">
                                    <h4 class="mb-3 text-primary">${titulo}</h4>
                                    <div class="mb-3">
                                        <img src="${imagenUrl}" 
                                             alt="Imagen de noticia" 
                                             class="img-fluid rounded" 
                                             style="max-height: 200px; object-fit: cover; width: 100%;"
                                             onerror="this.onerror=null; this.src='https://via.placeholder.com/800x400/4a6fa5/ffffff?text=Niagara+Viajes'">
                                    </div>
                                    <p class="text-justify">${escapeHtml(contenido.substring(0, 300))}${contenido.length > 300 ? '...' : ''}</p>
                                    <div class="mt-3 d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary me-2">Noticia</span>
                                        <small class="text-muted">
                                            <i class="far fa-calendar me-1"></i>
                                            ${new Date().toLocaleDateString('es-ES')}
                                        </small>
                                    </div>
                                </div>
                            `;
                            
                            previewContent.innerHTML = previewHTML;
                        } catch (error) {
                            console.error('Error al generar vista previa:', error);
                            previewContent.innerHTML = `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Error al generar vista previa
                                </div>
                            `;
                        }
                    };
                    
                    // Configurar listeners para los campos relevantes
                    const fieldsToWatch = ['tituloInput', 'contenidoNoticia', 'imagenUrl'];
                    fieldsToWatch.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            // Usar debounce para mejorar rendimiento
                            let debounceTimer;
                            field.addEventListener('input', function() {
                                clearTimeout(debounceTimer);
                                debounceTimer = setTimeout(updatePreview, 200);
                            });
                            console.log(`Listener agregado a: ${fieldId}`);
                        }
                    });
                    
                    // Inicializar vista previa
                    setTimeout(updatePreview, 100);
                    
                    console.log('Vista previa configurada correctamente');
                } catch (error) {
                    console.error('Error crítico en setupLivePreview:', error);
                }
            }
            
            // Validación de formulario robusta
            function setupFormValidation() {
                try {
                    console.log('Configurando validación de formulario...');
                    
                    const form = document.getElementById('noticiaForm');
                    const submitBtn = document.getElementById('submitBtn');
                    
                    if (!form) {
                        console.error('Formulario no encontrado');
                        return;
                    }
                    
                    // Deshabilitar validación nativa del navegador
                    form.setAttribute('novalidate', 'novalidate');
                    
                    // Validar campo individual
                    const validateField = (input, minLength, errorMessage) => {
                        const value = input.value.trim();
                        const isValid = value.length >= minLength;
                        
                        if (!isValid) {
                            input.classList.add('is-invalid');
                            if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('invalid-feedback')) {
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'invalid-feedback';
                                errorDiv.textContent = errorMessage;
                                input.parentNode.appendChild(errorDiv);
                            }
                        } else {
                            input.classList.remove('is-invalid');
                            const errorDiv = input.nextElementSibling;
                            if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                                errorDiv.remove();
                            }
                        }
                        
                        return isValid;
                    };
                    
                    // Validación en tiempo real
                    const tituloInput = document.getElementById('tituloInput');
                    const contenidoInput = document.getElementById('contenidoNoticia');
                    
                    if (tituloInput) {
                        tituloInput.addEventListener('blur', function() {
                            validateField(this, 5, 'El título debe tener al menos 5 caracteres');
                        });
                    }
                    
                    if (contenidoInput) {
                        contenidoInput.addEventListener('blur', function() {
                            validateField(this, 50, 'El contenido debe tener al menos 50 caracteres');
                        });
                    }
                    
                    // Validación al enviar
                    form.addEventListener('submit', function(event) {
                        console.log('Validando formulario antes de enviar...');
                        
                        event.preventDefault();
                        event.stopPropagation();
                        
                        let isValid = true;
                        const errors = [];
                        
                        // Validar título
                        if (tituloInput && !validateField(tituloInput, 5, 'El título debe tener al menos 5 caracteres')) {
                            isValid = false;
                            errors.push('Título muy corto (mínimo 5 caracteres)');
                        }
                        
                        // Validar contenido
                        if (contenidoInput && !validateField(contenidoInput, 50, 'El contenido debe tener al menos 50 caracteres')) {
                            isValid = false;
                            errors.push('Contenido muy corto (mínimo 50 caracteres)');
                        }
                        
                        if (isValid) {
                            console.log('Formulario válido, procediendo con envío...');
                            
                            // Deshabilitar botón para evitar doble envío
                            if (submitBtn) {
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
                            }
                            
                            // Enviar formulario
                            setTimeout(() => {
                                form.submit();
                            }, 100);
                        } else {
                            console.warn('Formulario inválido:', errors);
                            
                            // Mostrar alerta con errores
                            if (errors.length > 0) {
                                const alertHTML = `
                                    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Por favor corrige los siguientes errores:</strong>
                                        <ul class="mb-0 mt-1">
                                            ${errors.map(error => `<li>${error}</li>`).join('')}
                                        </ul>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                `;
                                
                                // Insertar alerta después del formulario
                                form.insertAdjacentHTML('afterend', alertHTML);
                                
                                // Desplazar a los errores
                                window.scrollTo({
                                    top: 0,
                                    behavior: 'smooth'
                                });
                            }
                        }
                        
                        form.classList.add('was-validated');
                    });
                    
                    console.log('Validación de formulario configurada');
                } catch (error) {
                    console.error('Error crítico en setupFormValidation:', error);
                }
            }
            
            // Inicialización principal con reintentos
            function init() {
                console.log('=== Iniciando aplicación ===');
                
                // Verificar que estamos en la página correcta
                if (!window.location.pathname.includes('/admin/noticias/createNews')) {
                    console.log('No es la página de creación de noticias, omitiendo inicialización');
                    return;
                }
                
                // Verificar dependencias
                if (!checkDependencies()) {
                    console.warn('Faltan dependencias, reintentando en 500ms...');
                    setTimeout(init, 500);
                    return;
                }
                
                // Inicializar componentes
                try {
                    setupCharacterCounters();
                    setupLivePreview();
                    setupFormValidation();
                    
                    console.log('=== Aplicación inicializada correctamente ===');
                    
                    // Marcar como cargado
                    document.body.setAttribute('data-app-loaded', 'true');
                    
                } catch (error) {
                    console.error('Error durante la inicialización:', error);
                    
                    // Mostrar mensaje de error al usuario
                    const errorAlert = `
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atención:</strong> Hubo un problema al cargar algunas funcionalidades.
                            Por favor, recarga la página o contacta con soporte.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    
                    const header = document.querySelector('.content-header');
                    if (header) {
                        header.insertAdjacentHTML('afterend', errorAlert);
                    }
                }
            }
            
            // Estrategias de inicialización múltiples
            function startApp() {
                // Intentar inmediatamente si el DOM ya está listo
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    console.log('DOM ya está listo, iniciando...');
                    setTimeout(init, 100);
                } else {
                    // Esperar a que el DOM esté listo
                    console.log('Esperando a que el DOM esté listo...');
                    document.addEventListener('DOMContentLoaded', function() {
                        console.log('DOMContentLoaded disparado');
                        setTimeout(init, 100);
                    });
                }
                
                // Backup: iniciar después de 3 segundos máximo
                setTimeout(function() {
                    if (!document.body.getAttribute('data-app-loaded')) {
                        console.warn('Inicialización por timeout');
                        init();
                    }
                }, 3000);
            }
            
            // Iniciar la aplicación
            startApp();
            
            // Exportar funciones para debugging
            window.__niagaraNewsDebug = {
                reinit: init,
                checkDeps: checkDependencies,
                version: '1.0.0-production'
            };
            
        })();
    </script>
    
    <!-- Script de diagnóstico adicional -->
    <script>
        // Solo en producción - Diagnóstico adicional
        if (window.location.hostname !== 'localhost' && !window.location.hostname.includes('127.0.0.1')) {
            window.addEventListener('error', function(e) {
                console.error('Error global capturado:', e.error);
                console.error('En archivo:', e.filename);
                console.error('Línea:', e.lineno, 'Columna:', e.colno);
            });
            
            // Verificar que Bootstrap esté cargado
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap no está cargado correctamente');
            }
        }
    </script>
</body>
</html>